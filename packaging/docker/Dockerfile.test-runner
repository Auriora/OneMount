# Multi-stage Dockerfile for running OneMount tests in isolation
# Extends onemount-base with test-specific dependencies and user setup
FROM onemount-base AS base

# Install test-specific dependencies not included in base image
RUN apt-get update && apt-get install -y \
    # Python for test scripts
    python3 \
    python3-pip \
    # Network tools for testing
    iputils-ping \
    netcat-openbsd \
    # Process management
    psmisc \
    # Additional system utilities for testing
    lsb-release \
    gnupg \
    # Cleanup
    && rm -rf /var/lib/apt/lists/*

# Create test user with FUSE access
RUN useradd -m -s /bin/bash -G fuse tester && \
    chown tester:tester /workspace

# Set Go environment for test user
ENV GOPATH="/home/tester/go"

# Dependency caching stage
FROM base AS deps

# Set up Go environment for test user
USER tester
RUN mkdir -p /home/tester/go && \
    echo 'export GOPATH=/home/tester/go' >> /home/tester/.bashrc && \
    echo 'export PATH=/usr/local/go/bin:$GOPATH/bin:$PATH' >> /home/tester/.bashrc

# Set working directory
WORKDIR /workspace

# Copy go.mod and go.sum first for better caching
COPY --chown=tester:tester go.mod go.sum ./

# Download dependencies (this layer will be cached unless go.mod/go.sum changes)
RUN go mod download

# Final stage
FROM deps AS final

# Copy source code (this will invalidate cache when source changes)
COPY --chown=tester:tester . .

# Create test directories
RUN mkdir -p /home/tester/.onemount-tests/tmp && \
    mkdir -p /home/tester/.onemount-tests/logs && \
    mkdir -p /home/tester/.cache/onemount

# Copy test entrypoint script and make it executable
COPY packaging/docker/test-entrypoint.sh /usr/local/bin/test-entrypoint.sh
USER root
RUN chmod +x /usr/local/bin/test-entrypoint.sh
USER tester

# Pre-build OneMount binaries for faster test execution
RUN bash scripts/cgo-helper.sh && \
    mkdir -p build/binaries && \
    CGO_CFLAGS=-Wno-deprecated-declarations go build -v \
        -o build/binaries/onemount \
        -ldflags="-X github.com/auriora/onemount/cmd/common.commit=$(git rev-parse HEAD 2>/dev/null || echo 'unknown')" \
        ./cmd/onemount && \
    CGO_CFLAGS=-Wno-deprecated-declarations go build -v \
        -o build/binaries/onemount-launcher \
        -ldflags="-X github.com/auriora/onemount/cmd/common.commit=$(git rev-parse HEAD 2>/dev/null || echo 'unknown')" \
        ./cmd/onemount-launcher

# Default command
ENTRYPOINT ["/usr/local/bin/test-entrypoint.sh"]
CMD ["help"]

# Add labels for better image management
LABEL org.opencontainers.image.title="OneMount Test Runner"
LABEL org.opencontainers.image.description="Docker image for running OneMount tests in isolation (extends onemount-base)"
LABEL org.opencontainers.image.vendor="Auriora"
LABEL org.opencontainers.image.source="https://github.com/Auriora/OneMount"
