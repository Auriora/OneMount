#!/usr/bin/env bash
set -euo pipefail

repo_root="$(cd -- "${BASH_SOURCE[0]%/*}/../.." && pwd)"

log() {
  printf '[python-toolchain] %s\n' "$*"
}

required_pkgs=(python-is-python3 python3 python3-dev python3-pip python3-venv)
missing_pkgs=()
for pkg in "${required_pkgs[@]}"; do
  if ! dpkg -s "$pkg" >/dev/null 2>&1; then
    missing_pkgs+=("$pkg")
  fi
done

if ((${#missing_pkgs[@]})); then
  log "Installing missing packages: ${missing_pkgs[*]}"
  sudo apt-get update
  sudo apt-get install -y --no-install-recommends "${missing_pkgs[@]}"
else
  log "All required Debian packages already installed"
fi

if ! command -v pip3 >/dev/null 2>&1; then
  log "pip3 still missing after apt install" >&2
  exit 1
fi

if ! command -v pip >/dev/null 2>&1; then
  log "Linking pip3 to pip"
  sudo ln -sf /usr/bin/pip3 /usr/local/bin/pip
fi

if ! command -v python >/dev/null 2>&1; then
  log "Ensuring python shim exists"
  sudo apt-get install -y --no-install-recommends python-is-python3 >/dev/null 2>&1 || true
fi

log "Python binary: $(command -v python3)"
python3 --version
python3 -m pip --version
pip3 --version
pip --version

python3 -m venv /tmp/python-postcreate-probe
/tmp/python-postcreate-probe/bin/python -m pip --version
rm -rf /tmp/python-postcreate-probe

log "Python toolchain verified"
