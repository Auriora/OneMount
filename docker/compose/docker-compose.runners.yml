# Docker Compose configuration for OneMount GitHub Actions Runners
# Consolidated file using profiles for different deployment scenarios
# Supports local and remote deployment
#
# Usage:
#   Development:  docker compose -f docker/compose/docker-compose.runners.yml --profile dev up -d
#   Production:   docker compose -f docker/compose/docker-compose.runners.yml --profile prod up -d
#   Remote:       DOCKER_HOST=tcp://remote:2376 docker compose -f docker/compose/docker-compose.runners.yml --profile prod up -d

name: onemount-runners

services:
  # Development runner - single runner for testing
  runner-dev:
    container_name: onemount-runner-dev
    build:
      context: ../..
      dockerfile: docker/Dockerfile.github-runner
    image: onemount-github-runner:latest
    
    environment:
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - GITHUB_REPOSITORY=${GITHUB_REPOSITORY}
      - RUNNER_NAME=onemount-runner-dev
      - RUNNER_LABELS=self-hosted,linux,onemount-testing,development
      - RUNNER_GROUP=${RUNNER_GROUP:-Default}
      - AUTH_TOKENS_B64=${AUTH_TOKENS_B64:-}
      - RUNNER_ALLOW_RUNASROOT=1
    
    volumes:
      - runner-dev-work:/opt/actions-runner/_work
      - runner-dev-workspace:/workspace
      - runner-dev-tokens:/opt/onemount-ci
    
    tmpfs:
      - /tmp:exec
      - /opt/actions-runner/_update
    
    devices:
      - /dev/fuse:/dev/fuse
    cap_add:
      - SYS_ADMIN
    security_opt:
      - apparmor:unconfined
    
    network_mode: bridge
    dns:
      - 8.8.8.8
      - 8.8.4.4
    
    user: "0:0"
    restart: "no"
    
    command: ["shell"]
    
    profiles:
      - dev
      - development

  # Production runner 1 - primary runner
  runner-1:
    container_name: onemount-runner-1
    build:
      context: ../..
      dockerfile: docker/Dockerfile.github-runner
    image: onemount-github-runner:latest
    
    environment:
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - GITHUB_REPOSITORY=${GITHUB_REPOSITORY}
      - RUNNER_NAME=onemount-runner-1
      - RUNNER_LABELS=self-hosted,linux,onemount-testing,production
      - RUNNER_GROUP=${RUNNER_GROUP:-Default}
      - AUTH_TOKENS_B64=${AUTH_TOKENS_B64:-}
      - RUNNER_ALLOW_RUNASROOT=1
    
    volumes:
      - runner-1-work:/opt/actions-runner/_work
      - runner-1-workspace:/workspace
      - runner-1-tokens:/opt/onemount-ci
    
    tmpfs:
      - /tmp:exec
      - /opt/actions-runner/_update
    
    devices:
      - /dev/fuse:/dev/fuse
    cap_add:
      - SYS_ADMIN
    security_opt:
      - apparmor:unconfined
    
    network_mode: bridge
    dns:
      - 8.8.8.8
      - 8.8.4.4
    
    user: "0:0"
    restart: unless-stopped
    
    command: ["run"]
    
    profiles:
      - prod
      - production

  # Production runner 2 - secondary runner
  runner-2:
    container_name: onemount-runner-2
    build:
      context: ../..
      dockerfile: docker/Dockerfile.github-runner
    image: onemount-github-runner:latest
    
    environment:
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - GITHUB_REPOSITORY=${GITHUB_REPOSITORY}
      - RUNNER_NAME=onemount-runner-2
      - RUNNER_LABELS=self-hosted,linux,onemount-testing,production
      - RUNNER_GROUP=${RUNNER_GROUP:-Default}
      - AUTH_TOKENS_B64=${AUTH_TOKENS_B64:-}
      - RUNNER_ALLOW_RUNASROOT=1
    
    volumes:
      - runner-2-work:/opt/actions-runner/_work
      - runner-2-workspace:/workspace
      - runner-2-tokens:/opt/onemount-ci
    
    tmpfs:
      - /tmp:exec
      - /opt/actions-runner/_update
    
    devices:
      - /dev/fuse:/dev/fuse
    cap_add:
      - SYS_ADMIN
    security_opt:
      - apparmor:unconfined
    
    network_mode: bridge
    dns:
      - 8.8.8.8
      - 8.8.4.4
    
    user: "0:0"
    restart: unless-stopped
    
    command: ["run"]
    
    profiles:
      - prod
      - production

volumes:
  # Development volumes
  runner-dev-work:
    driver: local
  runner-dev-workspace:
    driver: local
  runner-dev-tokens:
    driver: local
  
  # Production volumes
  runner-1-work:
    driver: local
  runner-1-workspace:
    driver: local
  runner-1-tokens:
    driver: local
  
  runner-2-work:
    driver: local
  runner-2-workspace:
    driver: local
  runner-2-tokens:
    driver: local

networks:
  default:
    driver: bridge
