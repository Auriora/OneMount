# Docker Compose configuration for building OneMount binaries and packages
# This file runs containers that perform builds
# Images will be built automatically if not present

name: onemount-build

services:
  # Build OneMount binaries
  build-binaries:
    container_name: onemount-build-binaries
    build:
      context: ../..
      dockerfile: packaging/deb/docker/Dockerfile
      args:
        - BUILDKIT_INLINE_CACHE=1
        - ONEMOUNT_VERSION=${ONEMOUNT_VERSION:-0.1.0rc1}
    image: onemount-deb-builder:${ONEMOUNT_VERSION:-latest}
    volumes:
      - ../..:/build:rw
      - ../../build:/workspace/build:rw
    working_dir: /build
    command: ["binaries", "--output", "/workspace/build"]
    profiles:
      - binaries
      - all

  # Clean build artifacts
  clean-build:
    container_name: onemount-clean-build
    build:
      context: ../..
      dockerfile: packaging/deb/docker/Dockerfile
      args:
        - BUILDKIT_INLINE_CACHE=1
        - ONEMOUNT_VERSION=${ONEMOUNT_VERSION:-0.1.0rc1}
    image: onemount-deb-builder:${ONEMOUNT_VERSION:-latest}
    volumes:
      - ../..:/build:rw
    working_dir: /build
    command: ["clean"]
    profiles:
      - clean
