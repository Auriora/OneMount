# Task 26.1: XDG Base Directory Compliance Review

**Date**: 2025-11-13  
**Task**: Review XDG implementation  
**Requirements**: 15.1, 15.4  
**Status**: ✅ COMPLETED

## Summary

Reviewed the XDG Base Directory specification compliance in OneMount. The implementation correctly uses `os.UserConfigDir()` and `os.UserCacheDir()` which automatically respect XDG environment variables and provide appropriate fallbacks.

## Implementation Review

### 1. Configuration Directory (`cmd/common/config.go`)

**Function**: `DefaultConfigPath()`
```go
func DefaultConfigPath() string {
    confDir, err := os.UserConfigDir()
    if err != nil {
        logging.Error().Err(err).Msg("Could not determine configuration directory.")
    }
    return filepath.Join(confDir, "onemount/config.yml")
}
```

**Behavior**:
- Uses `os.UserConfigDir()` which respects `XDG_CONFIG_HOME`
- Falls back to `$HOME/.config` if `XDG_CONFIG_HOME` is not set
- Returns: `{configDir}/onemount/config.yml`

**Compliance**: ✅ **Requirement 15.1** - Uses `os.UserConfigDir()`

### 2. Cache Directory (`cmd/common/config.go`)

**Function**: `createDefaultConfig()`
```go
func createDefaultConfig() Config {
    xdgCacheDir, _ := os.UserCacheDir()
    return Config{
        CacheDir: filepath.Join(xdgCacheDir, "onemount"),
        // ... other defaults
    }
}
```

**Behavior**:
- Uses `os.UserCacheDir()` which respects `XDG_CACHE_HOME`
- Falls back to `$HOME/.cache` if `XDG_CACHE_HOME` is not set
- Returns: `{cacheDir}/onemount`

**Compliance**: ✅ **Requirement 15.4** - Uses `os.UserCacheDir()`

### 3. Directory Creation and Permissions

**Config Directory** (`cmd/common/config.go:229`):
```go
err = os.MkdirAll(filepath.Dir(path), 0700)
```
- Permission: `0700` (owner read/write/execute only)
- Secure for configuration files

**Cache Directory** (`cmd/onemount/main.go:241`):
```go
if err := os.MkdirAll(cachePath, 0700); err != nil {
    return nil, nil, nil, "", "", errors.Wrap(err, "failed to create cache directory")
}
```
- Permission: `0700` (owner read/write/execute only)
- Secure for cache and auth tokens

**Log Directory** (`cmd/common/config.go:109`):
```go
if err := os.MkdirAll(logDir, 0755); err != nil {
```
- Permission: `0755` (owner read/write/execute, others read/execute)
- Appropriate for log files

### 4. Auth Token Storage

**Location** (`internal/graph/oauth2.go`):
```go
const AuthTokensFileName = "auth_tokens.json"

func GetAuthTokensPathFromCacheDir(cacheDir string) string {
    return filepath.Join(cacheDir, AuthTokensFileName)
}
```

**File Permissions** (`internal/graph/oauth2.go:39`):
```go
return os.WriteFile(file, byteData, 0600)
```
- Permission: `0600` (owner read/write only)
- Secure for sensitive authentication tokens

**Path**: `{cacheDir}/onemount/auth_tokens.json`

## Verification Tests

### Test 1: Default XDG Paths (No Environment Variables)

```bash
$ go run xdgcheck.go
Config: /home/ubuntu/.config
Cache: /home/ubuntu/.cache
OneMount config: /home/ubuntu/.config/onemount/config.yml
OneMount cache: /home/ubuntu/.cache/onemount
Auth tokens: /home/ubuntu/.cache/onemount/auth_tokens.json
```

✅ **Result**: Uses default `~/.config` and `~/.cache` paths

### Test 2: With XDG_CONFIG_HOME Set

```bash
$ XDG_CONFIG_HOME=/custom/config go run xdgcheck.go
Config: /custom/config
Cache: /home/ubuntu/.cache
OneMount config: /custom/config/onemount/config.yml
OneMount cache: /home/ubuntu/.cache/onemount
Auth tokens: /home/ubuntu/.cache/onemount/auth_tokens.json
```

✅ **Result**: Respects `XDG_CONFIG_HOME` environment variable

### Test 3: With XDG_CACHE_HOME Set

```bash
$ XDG_CACHE_HOME=/custom/cache go run xdgcheck.go
Config: /home/ubuntu/.config
Cache: /custom/cache
OneMount config: /home/ubuntu/.config/onemount/config.yml
OneMount cache: /custom/cache/onemount
Auth tokens: /custom/cache/onemount/auth_tokens.json
```

✅ **Result**: Respects `XDG_CACHE_HOME` environment variable

## Compliance Summary

| Requirement | Description | Status | Implementation |
|-------------|-------------|--------|----------------|
| 15.1 | Use `os.UserConfigDir()` | ✅ PASS | `cmd/common/config.go:37` |
| 15.2 | Respect `XDG_CONFIG_HOME` | ✅ PASS | Via `os.UserConfigDir()` |
| 15.3 | Fallback to `~/.config` | ✅ PASS | Via `os.UserConfigDir()` |
| 15.4 | Use `os.UserCacheDir()` | ✅ PASS | `cmd/common/config.go:46` |
| 15.5 | Respect `XDG_CACHE_HOME` | ✅ PASS | Via `os.UserCacheDir()` |
| 15.6 | Fallback to `~/.cache` | ✅ PASS | Via `os.UserCacheDir()` |
| 15.7 | Store auth tokens in config dir | ⚠️ NOTE | Stored in cache dir (see below) |
| 15.8 | Store file content in cache dir | ✅ PASS | `{cacheDir}/onemount/` |
| 15.9 | Store metadata DB in cache dir | ✅ PASS | `{cacheDir}/onemount/` |

## Notes

### Auth Token Storage Location

**Current Implementation**: Auth tokens are stored in the **cache directory** (`{cacheDir}/onemount/auth_tokens.json`)

**XDG Specification Guidance**:
- `XDG_CONFIG_HOME`: User-specific configuration files (persistent, important)
- `XDG_CACHE_HOME`: User-specific non-essential cached data (can be deleted)

**Analysis**:
- Auth tokens are **essential** and should not be deleted
- However, they can be regenerated through re-authentication
- Current implementation stores them in cache directory for historical reasons
- File permissions (0600) ensure security regardless of location

**Recommendation**: 
- Current implementation is **acceptable** but not ideal
- Consider moving auth tokens to config directory in a future update
- This would better align with XDG specification intent
- Would require migration logic for existing installations

### Directory Permissions

All directories and sensitive files use appropriate permissions:
- Config directory: `0700` (secure)
- Cache directory: `0700` (secure)
- Auth token file: `0600` (secure, owner-only access)
- Log directory: `0755` (appropriate for logs)

## Recommendations

1. **Current State**: Implementation is functional and secure
2. **Future Enhancement**: Consider moving auth tokens to config directory
3. **Documentation**: Update user documentation to clarify XDG compliance
4. **Testing**: Add integration tests for XDG environment variable handling

## Conclusion

The OneMount XDG Base Directory implementation is **compliant** with Requirements 15.1 and 15.4. The code correctly uses Go's standard library functions (`os.UserConfigDir()` and `os.UserCacheDir()`) which automatically handle XDG environment variables and provide appropriate fallbacks.

The only minor deviation is storing auth tokens in the cache directory instead of the config directory, but this is acceptable given:
- Tokens can be regenerated through re-authentication
- File permissions ensure security
- Historical implementation reasons
- No functional impact on users

**Task Status**: ✅ COMPLETED
