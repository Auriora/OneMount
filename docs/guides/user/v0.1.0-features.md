# OneMount v0.1.0 Feature Guide

This guide provides an overview of the features in OneMount's first public release.

## Table of Contents

1. [Realtime Synchronization with Socket.IO](#realtime-synchronization-with-socketio)
2. [ETag-Based Cache Validation](#etag-based-cache-validation)
3. [XDG Base Directory Compliance](#xdg-base-directory-compliance)
4. [Account-Based Token Storage](#account-based-token-storage)
5. [Offline Mode with Conflict Resolution](#offline-mode-with-conflict-resolution)
6. [Metadata State Machine](#metadata-state-machine)
7. [Configuration Options](#configuration-options)

---

## Realtime Synchronization with Socket.IO

OneMount v1.0.0 introduces realtime change notifications using Microsoft Graph Socket.IO subscriptions, providing instant updates when files change in OneDrive.

### How It Works

- **Socket.IO Connection**: OneMount establishes a WebSocket connection to Microsoft Graph
- **Instant Notifications**: Changes in OneDrive trigger immediate notifications
- **Automatic Fallback**: If Socket.IO fails, the system automatically falls back to polling
- **Adaptive Polling**: Polling frequency adjusts based on connection health

### Benefits

- **Immediate Updates**: See changes within seconds instead of waiting for polling intervals
- **Reduced Network Usage**: Less frequent polling when Socket.IO is healthy
- **Better Battery Life**: Fewer network requests mean better battery life on laptops
- **No Webhooks Required**: No need for publicly accessible endpoints or complex infrastructure

### Configuration

**Enable Socket.IO (recommended):**
```yaml
# ~/.config/onemount/config.yml
realtime:
  enabled: true
  pollingOnly: false
  fallbackIntervalSeconds: 1800  # 30 minutes
```

**Polling-Only Mode (for corporate networks):**
```yaml
realtime:
  enabled: true
  pollingOnly: true
  fallbackIntervalSeconds: 600   # 10 minutes
```

**Command-Line Options:**
```bash
# Force polling-only mode
onemount --polling-only /mnt/onedrive

# Set custom polling interval
onemount --realtime-fallback-seconds 900 /mnt/onedrive
```

### Monitoring

Check Socket.IO status:
```bash
onemount --stats /mnt/onedrive

# Look for:
# Realtime Notifications:
#   Mode: socketio
#   Status: healthy
#   Last heartbeat: 2026-01-26T10:30:45Z
```

### Troubleshooting

**If Socket.IO isn't working:**
1. Check if WebSocket connections are blocked by your firewall/proxy
2. Enable polling-only mode as a workaround
3. Contact your network administrator about WebSocket access to `*.graph.microsoft.com`

See the [Socket.IO Configuration Guide](../socketio-configuration.md) for detailed information.

---

## ETag-Based Cache Validation

OneMount uses ETags (entity tags) to efficiently validate cached files and ensure you always have the latest versions.

### How It Works

1. **Delta Sync Fetches ETags**: Background delta sync queries fetch file metadata including ETags
2. **ETag Comparison**: When you access a file, OneMount compares the cached ETag with the current ETag
3. **Automatic Invalidation**: If ETags differ, the cache is invalidated and the file is re-downloaded
4. **Efficient Downloads**: Only changed files are downloaded, saving bandwidth

### Benefits

- **Always Current**: You always get the latest file version
- **Bandwidth Efficient**: Only downloads files that have actually changed
- **No Conditional GET Required**: Works with Microsoft Graph's pre-authenticated download URLs
- **Proactive Detection**: Changes detected before you access the file

### How It Differs from Traditional Sync

**Traditional Sync Clients:**
- Download entire files to check for changes
- Use HTTP conditional GET (if-none-match headers)
- May download unchanged files unnecessarily

**OneMount ETag Validation:**
- Fetches only metadata via delta sync
- Compares ETags before downloading
- Downloads only when ETags indicate changes
- More efficient for large files and slow connections

### Monitoring

Check cache validation status:
```bash
onemount --stats /mnt/onedrive

# Look for:
# Cache Statistics:
#   Hit rate: 85.3%
#   Invalidations: 12
#   Total size: 2.3 GB
```

### Technical Details

- **ETag Source**: ETags come from Microsoft Graph delta sync responses
- **Validation Timing**: Checked on every file access
- **Cache Invalidation**: Automatic when ETag mismatch detected
- **Content Verification**: QuickXORHash used to verify downloaded content integrity

---

## XDG Base Directory Compliance

OneMount v1.0.0 follows the XDG Base Directory Specification, storing configuration and cache files in standard Linux locations.

### Standard Locations

**Configuration Directory:**
- Default: `~/.config/onemount/`
- Environment Variable: `$XDG_CONFIG_HOME/onemount/`
- Contains: `config.yml`, authentication tokens, metadata database

**Cache Directory:**
- Default: `~/.cache/onemount/`
- Environment Variable: `$XDG_CACHE_HOME/onemount/`
- Contains: Downloaded file content, temporary files

### Benefits

- **Standards Compliance**: Follows Linux filesystem hierarchy standards
- **Easier Backups**: Configuration and cache clearly separated
- **Better Integration**: Works with backup tools that respect XDG directories
- **Cleaner Home Directory**: No hidden files cluttering your home directory

### Virtual Files

OneMount creates virtual files like `.xdg-volume-info` that are served locally without syncing to OneDrive:

- **Local-Only**: Never uploaded to OneDrive
- **Immediate Availability**: Available even on first mount
- **Desktop Integration**: Provides volume information to file managers

### Custom Paths

Override default paths with command-line flags:
```bash
# Custom configuration directory
onemount --config-dir /custom/config /mnt/onedrive

# Custom cache directory
onemount --cache-dir /custom/cache /mnt/onedrive
```

### Migration

OneMount automatically migrates from old locations:
- Old config: `~/.config/onemount/.auth_tokens.json`
- New config: `~/.config/onemount/accounts/{account-hash}/auth_tokens.json`

---

## Account-Based Token Storage

Authentication tokens are now stored based on account identity rather than mount point location.

### How It Works

- **Account Hash**: Tokens stored at `~/.config/onemount/accounts/{account-hash}/auth_tokens.json`
- **Hash Generation**: SHA256 hash of account email provides stable identifier
- **Mount Point Independence**: Same tokens used regardless of where you mount
- **Automatic Migration**: Old tokens automatically migrated to new location

### Benefits

- **Multi-Mount Support**: Mount same account at different locations without token duplication
- **Docker Reliability**: Eliminates token path issues in containerized environments
- **Cleaner Organization**: All tokens for an account in one location
- **No Token Loss**: Tokens persist even if mount point changes

### Migration Process

1. **Automatic Detection**: OneMount checks for tokens in old locations
2. **Safe Migration**: Tokens copied (not moved) to new location
3. **Backward Compatibility**: Old locations still checked as fallback
4. **No User Action Required**: Migration happens automatically on first use

### Multiple Accounts

Each OneDrive account gets its own token storage:
```
~/.config/onemount/accounts/
├── a1b2c3d4.../auth_tokens.json  # Personal account
├── e5f6g7h8.../auth_tokens.json  # Work account
└── i9j0k1l2.../auth_tokens.json  # Shared drive
```

---

## Offline Mode with Conflict Resolution

OneMount v1.0.0 provides comprehensive offline functionality with intelligent conflict resolution.

### Offline Capabilities

**Full Read-Write Access:**
- Read previously accessed files
- Create new files
- Modify existing files
- Delete files
- All changes queued for synchronization

**Automatic Detection:**
- Network errors trigger offline mode
- Passive monitoring of API call failures
- Active connectivity checks when online

### Conflict Resolution

When you reconnect after making offline changes, OneMount detects conflicts using ETag comparison:

**Conflict Detection:**
- Local file modified while offline
- Same file modified remotely in OneDrive
- ETags differ, indicating conflict

**Resolution Strategies:**

1. **Last-Writer-Wins** (default):
   - Most recent modification wins
   - Based on modification timestamps
   - Automatic resolution

2. **Keep-Both**:
   - Local version keeps original name
   - Remote version saved with timestamp suffix
   - Both versions preserved

3. **User-Choice**:
   - Presents resolution options to user
   - Manual selection required
   - Full control over resolution

4. **Merge**:
   - Attempts automatic merging for compatible changes
   - Falls back to keep-both if merge fails
   - Best for text files

5. **Rename**:
   - Creates separate versions with conflict indicators
   - Clear naming shows conflict status
   - Easy to identify and resolve manually

### Configuration

```yaml
# ~/.config/onemount/config.yml
offline:
  connectivityCheckInterval: 15  # seconds
  connectivityTimeout: 10        # seconds
  maxPendingChanges: 1000        # maximum queued changes
  conflictResolution: "keep-both"  # default strategy
```

### Monitoring

Check offline status:
```bash
onemount --stats /mnt/onedrive

# Look for:
# Offline Mode:
#   Status: online | offline
#   Pending changes: 5
#   Last connectivity check: 2026-01-26T10:30:45Z
```

### Best Practices

1. **Sync Before Going Offline**: Ensure recent files are cached
2. **Monitor Pending Changes**: Check queue size periodically
3. **Resolve Conflicts Promptly**: Address conflicts when reconnecting
4. **Use Appropriate Strategy**: Choose resolution strategy for your workflow

See the [Offline Functionality Guide](../../3-implementation/offline-functionality.md) for detailed information.

---

## Metadata State Machine

OneMount uses an explicit state machine to track file lifecycle and operations.

### File States

**GHOST** - Cloud metadata known, no local content:
- File exists in OneDrive but not downloaded
- Blocks file access until hydration
- Transitions to HYDRATING when accessed

**HYDRATING** - Content download in progress:
- Download worker actively fetching content
- Progress tracked and reported
- Transitions to HYDRATED on success, ERROR on failure

**HYDRATED** - Local content matches remote ETag:
- File fully available locally
- Content matches OneDrive version
- Can be read, modified, or evicted

**DIRTY_LOCAL** - Local changes pending upload:
- File modified locally
- Upload queued
- Transitions to HYDRATED after successful upload

**DELETED_LOCAL** - Local delete queued for upload:
- File deleted locally
- Delete operation queued
- Removed after server confirmation

**CONFLICT** - Local and remote versions diverged:
- Both local and remote changes detected
- Conflict resolution required
- User intervention needed

**ERROR** - Last operation failed:
- Hydration or upload failed
- Error details preserved
- Manual retry available

### State Transitions

```
GHOST → HYDRATING → HYDRATED → DIRTY_LOCAL → HYDRATED
  ↓         ↓           ↓            ↓
ERROR ← ─ ─ ┘           ↓            ↓
                        ↓            ↓
                   DELETED_LOCAL  CONFLICT
```

### Benefits

- **Clear Lifecycle**: Explicit states make file status obvious
- **Error Recovery**: Failed operations can be retried
- **Conflict Detection**: Automatic detection of divergent changes
- **Progress Tracking**: State transitions provide progress information

### Monitoring

Check file states:
```bash
onemount --stats /mnt/onedrive

# Look for:
# File States:
#   GHOST: 1,234
#   HYDRATED: 567
#   DIRTY_LOCAL: 12
#   HYDRATING: 3
#   ERROR: 1
```

---

## Configuration Options

OneMount v1.0.0 provides extensive configuration options for customizing behavior.

### Configuration File

Location: `~/.config/onemount/config.yml`

**Complete Example:**
```yaml
# Realtime notifications
realtime:
  enabled: true
  pollingOnly: false
  fallbackIntervalSeconds: 1800

# Download configuration
hydration:
  workers: 4
  queueSize: 500
  retryAttempts: 3
  chunkSize: 10485760  # 10 MB

# Metadata requests
metadataQueue:
  workers: 3
  highPrioritySize: 100
  lowPrioritySize: 1000

# Cache management
cache:
  maxSizeMB: 10000
  expirationDays: 30
  cleanupIntervalHours: 24

# Offline mode
offline:
  connectivityCheckInterval: 15
  connectivityTimeout: 10
  maxPendingChanges: 1000
  conflictResolution: "keep-both"

# Upload configuration
upload:
  maxRetries: 5
  retryDelaySeconds: 2
  chunkSize: 10485760  # 10 MB

# Virtual file overlay
overlay:
  defaultPolicy: "LOCAL_WINS"
```

### Command-Line Options

**Realtime:**
- `--polling-only` - Force polling-only mode
- `--realtime-fallback-seconds N` - Set polling interval

**Hydration:**
- `--hydration-workers N` - Set download worker count (1-64)
- `--hydration-queue-size N` - Set download queue size (1-100000)

**Metadata:**
- `--metadata-workers N` - Set metadata worker count (1-64)
- `--metadata-high-queue-size N` - Set high-priority queue size
- `--metadata-low-queue-size N` - Set low-priority queue size

**Overlay:**
- `--overlay-policy POLICY` - Set overlay policy (LOCAL_WINS, REMOTE_WINS, MERGED)

**Statistics:**
- `--stats` - Display comprehensive statistics

### Validation

Configuration values are validated on startup:
- Worker counts: 1-64
- Queue sizes: 1-100000
- Polling intervals: 30-7200 seconds
- Invalid values rejected with clear error messages

### Best Practices

1. **Start with Defaults**: Default values work well for most users
2. **Adjust for Network**: Increase workers for fast connections
3. **Monitor Performance**: Use `--stats` to check if adjustments needed
4. **Document Changes**: Comment your configuration file
5. **Test Changes**: Verify configuration changes work as expected

---

## Getting Started

To start using OneMount v0.1.0:

1. **Install OneMount**: Follow the [Installation Guide](installation-guide.md)
2. **Configure Realtime**: Enable Socket.IO for instant updates
3. **Mount OneDrive**: `onemount /mnt/onedrive`
4. **Monitor Status**: `onemount --stats /mnt/onedrive`
5. **Customize**: Adjust configuration as needed

For troubleshooting, see the [Troubleshooting Guide](troubleshooting-guide.md).

For detailed configuration, see the [Socket.IO Configuration Guide](../socketio-configuration.md).
