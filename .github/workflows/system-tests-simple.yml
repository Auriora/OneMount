name: System Tests (Simple)

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  system-tests:
    runs-on: ubuntu-latest
    
    # Only run if we have the test account credentials
    if: ${{ secrets.ONEDRIVE_TEST_TOKENS != '' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
        cache: true
    
    - name: Install FUSE
      run: |
        sudo apt-get update
        sudo apt-get install -y fuse3 libfuse3-dev
    
    - name: Set up test credentials
      env:
        # This should be a base64-encoded JSON file with the auth tokens
        ONEDRIVE_TEST_TOKENS: ${{ secrets.ONEDRIVE_TEST_TOKENS }}
      run: |
        # Create test directories
        mkdir -p ~/.onemount-tests/logs
        chmod 700 ~/.onemount-tests
        
        # Decode and save the auth tokens
        echo "$ONEDRIVE_TEST_TOKENS" | base64 -d > ~/.onemount-tests/.auth_tokens.json
        chmod 600 ~/.onemount-tests/.auth_tokens.json
        
        # Verify the tokens file is valid JSON
        if ! jq empty ~/.onemount-tests/.auth_tokens.json; then
          echo "❌ Invalid auth tokens format"
          exit 1
        fi
        
        echo "✅ Test credentials configured"
    
    - name: Build OneMount
      run: make build
    
    - name: Run comprehensive system tests
      run: |
        chmod +x scripts/run-system-tests.sh
        timeout 15m ./scripts/run-system-tests.sh --comprehensive --verbose
    
    - name: Upload test logs
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: system-test-logs-simple
        path: ~/.onemount-tests/logs/
        retention-days: 7
    
    - name: Cleanup
      if: always()
      run: |
        rm -rf ~/.onemount-tests/ || true
        fusermount3 -uz ~/.onemount-tests/tmp/system-test-mount 2>/dev/null || true
